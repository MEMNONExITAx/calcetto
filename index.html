<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcetto - Disponibilità</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f4f4; text-align:center; padding:20px; color: #333; }
    h1 { color: #2c3e50; }
    .box { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin-left: auto; margin-right: auto; }
    .player { padding:10px; margin:5px; border-radius:8px; border:1px solid #ddd; display:flex; justify-content: space-between; align-items: center; background: #fff; }
    .available { border-left: 5px solid #4CAF50; }
    .selected { background:#e3f2fd; border-left: 5px solid #2196F3; }
    input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 60%; }
    button { padding:10px 15px; margin-top:10px; cursor: pointer; border: none; border-radius: 5px; background-color: #2c3e50; color: white; font-weight: bold; }
    button:hover { background-color: #34495e; }
    button.danger { background-color: #e74c3c; }
    .badge { background: #eee; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: #555; }
    .history-item { text-align: left; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
    .history-date { font-weight: bold; color: #2196F3; display: block; margin-bottom: 4px;}
    .history-names { color: #555; font-style: italic; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, deleteDoc, doc, orderBy, updateDoc, Timestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURAZIONE FIREBASE (INSERISCI I TUOI DATI QUI) ---
    const firebaseConfig = {
      apiKey: "INSERISCI_API_KEY",
      authDomain: "INSERISCI_AUTH_DOMAIN",
      projectId: "INSERISCI_PROJECT_ID",
      storageBucket: "INSERISCI_STORAGE_BUCKET",
      messagingSenderId: "INSERISCI_MESSAGING_SENDER_ID",
      appId: "INSERISCI_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const availabilityRef = collection(db, "availability");
    const historyRef = collection(db, "history");
    const playersRef = collection(db, "players");

    let localPlayerStats = {}; 
    let currentAvailabilityList = []; 

    const isAdmin = new URLSearchParams(window.location.search).get("admin") === "1234";

    // --- FUNZIONE PER DARE DISPONIBILITÀ ---
    window.setAvailability = async function() {
      const nameInput = document.getElementById("nameInput");
      const rawName = nameInput.value.trim();
      
      if (!rawName) return alert("Inserisci un nome valido!");
      const name = rawName.toUpperCase(); // Forza maiuscolo per evitare duplicati (Mario vs mario)

      try {
        // 1. Crea il giocatore nelle statistiche se non esiste (senza bloccare)
        const playerQuery = query(playersRef, where("name", "==", name));
        const playerSnap = await getDocs(playerQuery);
        if (playerSnap.empty) {
          await addDoc(playersRef, { name: name, games: 0 });
        }

        // 2. Controlla se è già in lista per questa partita
        const availQuery = query(availabilityRef, where("name", "==", name));
        const availSnap = await getDocs(availQuery);

        if (!availSnap.empty) {
          alert("Sei già in lista!");
          nameInput.value = "";
          return;
        }

        // 3. Aggiungi disponibilità
        await addDoc(availabilityRef, { 
          name: name, 
          timestamp: Timestamp.now() 
        });
        
        nameInput.value = "";
        alert(`Grande ${name}, sei in lista!`);

      } catch (error) {
        console.error("Errore:", error);
        alert("Errore: " + error.message);
      }
    }

    // --- FUNZIONE GENERAZIONE SQUADRA (RISCRITTA E PIÙ SICURA) ---
    window.generateTeam = async function() {
      if (!confirm("Confermi di voler generare la squadra e chiudere le iscrizioni?")) return;

      try {
        // 1. Recupera tutti i disponibili in ordine di tempo
        const q = query(availabilityRef, orderBy("timestamp"));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            alert("Nessun giocatore disponibile!");
            return;
        }

        const allDocs = snapshot.docs;
        // Prendi i primi 10 (o meno se non ce ne sono 10)
        const selectedDocs = allDocs.slice(0, 10); 
        
        // Estrai SUBITO i nomi in un array semplice (evita crash nei loop successivi)
        const selectedNames = selectedDocs.map(doc => doc.data().name);

        console.log("Convocati:", selectedNames); // Debug console

        // 2. Salva PRIMA lo storico (così non perdiamo i dati se succede un errore dopo)
        await addDoc(historyRef, { 
            date: Timestamp.now(), 
            players: selectedNames 
        });

        // 3. Aggiorna UI Admin
        const selectedDiv = document.getElementById("selectedList");
        selectedDiv.innerHTML = "<h4>Convocati Generati:</h4>";
        selectedNames.forEach(name => {
            const div = document.createElement("div");
            div.className = "player selected";
            div.innerText = name;
            selectedDiv.appendChild(div);
        });

        // 4. Aggiorna statistiche partite (try-catch per ogni giocatore per non bloccare tutto)
        for (const name of selectedNames) {
            try {
                const pQuery = query(playersRef, where("name", "==", name));
                const pSnap = await getDocs(pQuery);
                if (!pSnap.empty) {
                    const pDoc = pSnap.docs[0];
                    const currentGames = pDoc.data().games || 0;
                    await updateDoc(doc(db, "players", pDoc.id), { games: currentGames + 1 });
                }
            } catch (e) {
                console.error(`Errore aggiornamento stats per ${name}:`, e);
            }
        }

        // 5. Pulizia: Rimuovi TUTTE le disponibilità (sia convocati che esclusi)
        for (const d of allDocs) {
            await deleteDoc(doc(db, "availability", d.id));
