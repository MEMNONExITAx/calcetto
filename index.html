<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcetto - Disponibilit√†</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f4f4; text-align:center; padding:20px; color: #333; }
    h1 { color: #2c3e50; }
    .box { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin-left: auto; margin-right: auto; }
    .player { padding:10px; margin:5px; border-radius:8px; border:1px solid #ddd; display:flex; justify-content: space-between; align-items: center; background: #fff; }
    .available { border-left: 5px solid #4CAF50; }
    .selected { background:#e3f2fd; border-left: 5px solid #2196F3; }
    input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 60%; }
    button { padding:10px 15px; margin-top:10px; cursor: pointer; border: none; border-radius: 5px; background-color: #2c3e50; color: white; font-weight: bold; }
    button:hover { background-color: #34495e; }
    button.danger { background-color: #e74c3c; }
    .badge { background: #eee; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: #555; }
    .history-item { text-align: left; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9em; }
    .history-date { font-weight: bold; color: #2196F3; font-size: 0.8em; display: block; margin-bottom: 4px;}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, deleteDoc, doc, orderBy, updateDoc, Timestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
      apiKey: "INSERISCI_API_KEY",
      authDomain: "INSERISCI_AUTH_DOMAIN",
      projectId: "INSERISCI_PROJECT_ID",
      storageBucket: "INSERISCI_STORAGE_BUCKET",
      messagingSenderId: "INSERISCI_MESSAGING_SENDER_ID",
      appId: "INSERISCI_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const availabilityRef = collection(db, "availability");
    const historyRef = collection(db, "history");
    const playersRef = collection(db, "players");

    // Stato locale per combinare i dati
    let localPlayerStats = {}; // Mappa nome -> partite giocate
    let currentAvailabilityList = []; // Lista di chi ha dato disponibilit√†

    const isAdmin = new URLSearchParams(window.location.search).get("admin") === "1234";

    // --- FUNZIONI GLOBALI (Window) ---

    window.setAvailability = async function() {
      const nameInput = document.getElementById("nameInput");
      const name = nameInput.value.trim().toUpperCase(); // Normalizziamo i nomi in maiuscolo
      if (!name) return alert("Inserisci un nome valid!");

      try {
        // 1. Controlla/Crea Giocatore nel database statistiche
        const playerQuery = query(playersRef, where("name", "==", name));
        const playerSnap = await getDocs(playerQuery);
        
        if (playerSnap.empty) {
          await addDoc(playersRef, { name: name, games: 0 });
          console.log("Nuovo giocatore registrato:", name);
        }

        // 2. Controlla se ha gi√† dato disponibilit√†
        const availQuery = query(availabilityRef, where("name", "==", name));
        const availSnap = await getDocs(availQuery);

        if (!availSnap.empty) {
          alert("Hai gi√† dato la disponibilit√† per questa partita!");
          nameInput.value = "";
          return;
        }

        // 3. Aggiungi disponibilit√†
        await addDoc(availabilityRef, { 
          name: name, 
          timestamp: Timestamp.now() 
        });
        
        nameInput.value = "";
        alert(`Grande ${name}, sei in lista!`);

      } catch (error) {
        console.error("Errore:", error);
        alert("Errore durante l'inserimento: " + error.message);
      }
    }

    window.generateTeam = async function() {
      if (!confirm("Confermi di voler generare la squadra e chiudere le iscrizioni?")) return;

      try {
        // Prendi i primi 10 in ordine cronologico
        const q = query(availabilityRef, orderBy("timestamp"));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            alert("Nessun giocatore disponibile!");
            return;
        }

        const allDocs = snapshot.docs;
        const selectedDocs = allDocs.slice(0, 10); // Primi 10
        const selectedNames = [];

        const selectedDiv = document.getElementById("selectedList");
        selectedDiv.innerHTML = "<h4>Convocati:</h4>";

        // Aggiorna contatore partite per i convocati
        for (const d of selectedDocs) {
            const name = d.data().name;
            selectedNames.push(name);
            
            // UI Update immediato
            const div = document.createElement("div");
            div.className = "player selected";
            div.innerText = name;
            selectedDiv.appendChild(div);

            // Aggiorna DB stats
            const pQuery = query(playersRef, where("name", "==", name));
            const pSnap = await getDocs(pQuery);
            if (!pSnap.empty) {
                const pDoc = pSnap.docs[0];
                const currentGames = pDoc.data().games || 0;
                await updateDoc(doc(db, "players", pDoc.id), { games: currentGames + 1 });
            }
        }

        // Salva storico
        await addDoc(historyRef, { 
            date: Timestamp.now(), 
            players: selectedNames 
        });

        // Pulisci disponibilit√† (rimuovi TUTTI quelli che si erano segnati, anche gli esclusi)
        // Se vuoi mantenere gli esclusi per la prossima volta, cambia logica qui.
        for (const d of allDocs) {
            await deleteDoc(doc(db, "availability", d.id));
        }

        alert("Squadra generata e storico salvato!");

      } catch (e) {
        console.error(e);
        alert("Errore generazione: " + e.message);
      }
    }

    window.resetAvailability = async function() {
      if (!confirm("Cancellare TUTTE le disponibilit√† correnti?")) return;
      const snapshot = await getDocs(availabilityRef);
      snapshot.forEach(async (d) => {
        await deleteDoc(doc(db, "availability", d.id));
      });
      document.getElementById("selectedList").innerHTML = "";
    }

    // --- FUNZIONI DI RENDERING ---

    // Questa funzione unisce i dati: Lista disponibilit√† + Statistiche giocatore
    function renderMainList() {
        const list = document.getElementById("availableList");
        list.innerHTML = "";
        
        if (currentAvailabilityList.length === 0) {
            list.innerHTML = "<p style='color:#777'>Nessuno ancora disponibile...</p>";
            return;
        }

        // Ordiniamo per chi si √® iscritto prima
        currentAvailabilityList.sort((a, b) => a.timestamp - b.timestamp);

        currentAvailabilityList.forEach((p, index) => {
            const div = document.createElement("div");
            div.className = 'player available';
            
            // Recupera le partite giocate dalla memoria locale
            const gamesCount = localPlayerStats[p.name] || 0;
            
            // Logica: i primi 10 sono verdi scuro, gli altri riserve (opzionale visivamente)
            const statusColor = index < 10 ? "#4CAF50" : "#FF9800"; 
            div.style.borderLeftColor = statusColor;

            div.innerHTML = `
                <strong>${index + 1}. ${p.name}</strong> 
                <span class="badge">Partite: ${gamesCount}</span>
            `;
            list.appendChild(div);
        });
    }

    function renderHistory(historyData) {
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      // Ordina dal pi√π recente
      historyData.sort((a,b) => b.date - a.date); 

      historyData.forEach(h => {
        const div = document.createElement("div");
        div.className = "history-item";
        
        let dateStr = "Data sconosciuta";
        if (h.date && h.date.toDate) {
            dateStr = h.date.toDate().toLocaleDateString('it-IT', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
        }

        div.innerHTML = `
            <span class="history-date">üìÖ ${dateStr}</span>
            <span>${h.players.join(', ')}</span>
        `;
        list.appendChild(div);
      });
    }

    // --- LISTENERS REAL-TIME ---

    // 1. Ascolta i dati dei giocatori (per le statistiche)
    onSnapshot(playersRef, (snapshot) => {
      localPlayerStats = {}; // Reset cache
      snapshot.forEach(doc => {
        const d = doc.data();
        localPlayerStats[d.name] = d.games;
      });
      // Ridisegna la lista se abbiamo aggiornamenti sulle stats
      renderMainList();
    });

    // 2. Ascolta la lista delle disponibilit√†
    onSnapshot(availabilityRef, (snapshot) => {
      currentAvailabilityList = snapshot.docs.map(d => d.data());
      renderMainList();
    });

    // 3. Ascolta lo storico
    onSnapshot(historyRef, (snapshot) => {
      const historyData = snapshot.docs.map(d => d.data());
      renderHistory(historyData);
    });

    // --- INIT ---
    window.onload = function() {
      if (isAdmin) {
        document.getElementById("adminPanel").style.display = "block";
      }
    }
  </script>
</head>
<body>

<h1>‚öΩ Disponibilit√† Calcetto</h1>

<div class="box">
  <input type="text" id="nameInput" placeholder="Il tuo nome (es. MARIO)">
  <button onclick="setAvailability()">üôã Ci sono!</button>
</div>

<div class="box">
  <h3>Lista Disponibili</h3>
  <div id="availableList"></div>
</div>

<div id="adminPanel" style="display:none; border: 2px dashed #ccc;">
  <div class="box" style="background: #fff8e1;">
    <h3>üîê Pannello Admin</h3>
    <p><small>Genera la squadra definitiva e aggiorna le presenze.</small></p>
    
    <button onclick="generateTeam()">‚úÖ Genera Squadra & Salva</button>
    <button onclick="resetAvailability()" class="danger">üóëÔ∏è Reset Tutto</button>
    
    <div id="selectedList" style="margin-top:15px; text-align:left;"></div>
    
    <hr>
    <h3>Storico Partite</h3>
    <div id="historyList"></div>
  </div>
</div>

</body>
</html>
